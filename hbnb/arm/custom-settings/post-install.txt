#!/bin/bash

install_files my-files.list
install_files custom_files.txt

chroot /rootfs /usr/sbin/update-locale LC_ALL="en_US.UTF-8" &&
chroot /rootfs /usr/sbin/update-locale LANGUAGE="en_US:en" &&

chroot /rootfs apt update &&
chroot /rootfs apt upgrade -y &&
chroot /rootfs apt autoremove -y &&
chroot /rootfs apt autoclean -y &&
chroot /rootfs dpkg --configure -a &&

chroot /rootfs apt-get install -y firmware-brcm80211 pi-bluetooth git-svn subversion gawk apache2 php php-cli libapache2-mod-php php-mcrypt &&

chroot /rootfs awk 'BEGIN{printf(" ")}1' /etc/wpa_supplicant.conf &&
chroot /rootfs echo sed -i '1s/^/country=RD\n/' /etc/wpa_supplicant.conf &&
chroot /rootfs echo sed -i '1s/^/update_config=1\n/' /etc/wpa_supplicant.conf &&
chroot /rootfs echo sed -i '1s/^/ctrl_interface=DIR=\/var\/run\/wpa_supplicant GROUP=netdev\n/' /etc/wpa_supplicant.conf &&
chroot /rootfs cp -r /etc/wpa_supplicant.conf /boot/ &&

chroot /rootfs rm -r /etc/systemd/system/getty@tty1.service.d >&- 2>&- &&
chroot /rootfs chmod +x /etc/init.d/build.sh &&
chroot /rootfs update-rc.d /etc/init.d/build.sh default &&

chroot /rootfs mkdir -p /etc/systemd/system/getty@tty1.service.d &&
chroot /rootfs touch /etc/systemd/system/getty@tty1.service.d/override.conf &&

{ echo "[Service]";
  echo "ExecStart=";
  echo "ExecStart=-/sbin/agetty --autologin pi --noclear %I $TERM";
  echo "hotspotbnb:  $";
} | chroot /rootfs tee /etc/systemd/system/getty@tty1.service.d/override.conf

chroot /rootfs sleep 15
chroot /rootfs reboot
