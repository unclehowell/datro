#!/bin/bash
#custom-settings/config/ to raspberrypi-ua-netinst/config/

#chroot /rootfs export DEBIAN_FRONTEND=noninteractive && ## directory not found error
install_files my-files.list &&
chroot /rootfs sleep 20 &&

chroot /rootfs /usr/sbin/update-locale LC_ALL="en_US.UTF-8" &&
chroot /rootfs /usr/sbin/update-locale LANGUAGE="en_US:en" &&
chroot /rootfs /usr/sbin/update-locale LANG="en_US.UTF-8" &&
chroot /rootfs /usr/sbin/locale-gen en_US.UTF-8 &&
chroot /rootfs /usr/sbin/dpkg-reconfigure --frontend=noninteractive locales &&

chroot /rootfs sed -i '1 i\update_config=1' /etc/wpa_supplicant/wpa_supplicant.conf &&
chroot /rootfs sed -i '1 i\ctrl_interface=DIR=\/var\/run\/wpa_supplicant GROUP=netdev' /etc/wpa_supplicant/wpa_supplicant.conf &&
chroot /rootfs cp -r /etc/wpa_supplicant/wpa_supplicant.conf /boot/ &&

chroot /rootfs rm -r /etc/systemd/system/getty@tty1.service.d >&- 2>&-
chroot /rootfs mkdir -p /etc/systemd/system/getty@tty1.service.d &&
chroot /rootfs touch /etc/systemd/system/getty@tty1.service.d/override.conf &&

{ echo "[Service]";
  echo "ExecStart=";
  echo "ExecStart=-/sbin/agetty --autologin pi --noclear %I $TERM";
  echo "hotspotbnb:  $";
} | chroot /rootfs tee /etc/systemd/system/getty@tty1.service.d/override.conf &&

chroot /rootfs systemctl enable systemd-networkd && #hbnb-arm.13
chroot /rootfs chmod u+x /etc/init.d/giodt.sh && # hbnb-arm.13
chroot /rootfs chmod u+x /home/pi/hbnbuild.sh && # hbnb-arm.13
chroot /rootfs sleep 2 &&
chroot /rootfs update-rc.d giodt.sh defaults &&
chroot /rootfs cp /home/systemd/system/hbnbuild.service /lib/systemd/system/ &  #hbnb-arm.13
chroot /rootfs systemctl daemon-reload && #hbnb.arm.13
chroot /rootfs systemctl enable hbnbuild.service && #hbnb-arm.13 

chroot /rootfs rm /dev/null &&
chroot /rootfs mknod /dev/null c 1 3 &&
chroot /rootfs chmod 666 /dev/null &&

chroot /rootfs apt -y update &&
chroot /rootfs apt -y upgrade &&
chroot /rootfs apt -y autoremove &&
chroot /rootfs apt -y autoclean &&
chroot /rootfs dpkg --configure -a &&
chroot /rootfs sleep 10 &&
chroot /rootfs apt -y install git &&
chroot /rootfs apt -y install git-svn &&
chroot /rootfs apt -y install subversion &&
chroot /rootfs apt -y install apache2 &&
chroot /rootfs apt -y install php php-common &&
chroot /rootfs apt -y install php-cli php-fpm php-json php-mysql php-zip php-gd php-mbstring php-curl php-xml php-pear php-bcmath &&
chroot /rootfs apt -y install libapache2-mod-php &&
chroot /rootfs update-alternatives --config php &&

chroot /rootfs chown root:root /etc/sudoers /etc/sudoers.d -R && #fix for error (pid 1000 when it should be 0)
chroot /rootfs printf "www-data ALL = NOPASSWD: /sbin/reboot, /sbin/halt" >> /etc/sudoers &&

chroot /rootfs reboot

